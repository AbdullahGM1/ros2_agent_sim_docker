#
# Custom ROS2 Humble + Gazebo Garden + XRCE-DDS + PX4 + MAVROS + ROSA + ChatOllama + Qwen3:8b
#

FROM ubuntu:22.04
LABEL maintainer="AbdullahGM1 <agm.musalami@gmail.com>"

#
# Install ROS2 Humble Desktop Full
#
ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Update and install basic dependencies
RUN apt update && apt install -y curl software-properties-common && add-apt-repository universe \
	&& apt-get -y autoremove \
	&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/{apt,dpkg,cache,log} /tmp/* /var/tmp/*

# Add ROS2 repository
RUN curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
RUN echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

# Install ROS2 Humble Desktop Full
RUN apt update && apt upgrade -y
RUN apt install -y ros-humble-desktop-full ros-dev-tools \
	&& apt-get -y autoremove \
	&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/{apt,dpkg,cache,log} /tmp/* /var/tmp/*

#
# Setup XRCE-DDS Agent & Client
#
RUN git clone https://github.com/eProsima/Micro-XRCE-DDS-Agent.git && \
    cd Micro-XRCE-DDS-Agent && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make && \
    make install && \
    ldconfig /usr/local/lib/

RUN apt-get update && apt-get -y --quiet --no-install-recommends install \
		bzip2 \
		ca-certificates \
		ccache \
		cmake \
		cppcheck \
		dirmngr \
		doxygen \
		file \
		g++ \
		gcc \
		gdb \
		git \
		gnupg \
		gosu \
		lcov \
		libfreetype6-dev \
		libgtest-dev \
		libpng-dev \
		libssl-dev \
		lsb-release \
		make \
		openssh-client \
		pkg-config \
		python3-dev \
		python3-pip \
		rsync \
		shellcheck \
		tzdata \
		unzip \
		valgrind \
		wget \
		xsltproc \
		zip \
        gedit \
		bash-completion \
		command-not-found \
	&& apt-get -y autoremove \
	&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/{apt,dpkg,cache,log} /tmp/* /var/tmp/*

# Create user FIRST (before copying scripts)
RUN useradd --shell /bin/bash -u 1000 -c "" -m user && usermod -a -G dialout user && echo "user:user" | chpasswd && adduser user sudo

COPY scripts/px4_dev.sh /tmp/px4_dev.sh
COPY scripts/requirements.txt /tmp/requirements.txt

#
# Install PX4 dev requirements
#
RUN /tmp/px4_dev.sh

# Some QT-Apps/Gazebo don't not show controls without this
ENV QT_X11_NO_MITSHM 1

# Use UTF8 encoding in java tools (needed to compile jMAVSim)
ENV JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF8

# Install JSBSim
RUN wget https://github.com/JSBSim-Team/jsbsim/releases/download/v1.1.13/JSBSim-devel_1.1.13-986.jammy.amd64.deb
RUN dpkg -i JSBSim-devel_1.1.13-986.jammy.amd64.deb

#
# Install VS Code for easy code development
#
RUN wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg && \
	install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg && \
	sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list' && \
	rm -f packages.microsoft.gpg
RUN apt install -y apt-transport-https && \
	apt update && \
	apt install -y code \
	&& apt-get -y autoremove \
	&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/{apt,dpkg,cache,log} /tmp/* /var/tmp/*

RUN echo "source /opt/ros/humble/setup.bash" >> /home/user/.bashrc

#
# Remove binary pkg ros-humble-ros-gz-bridge. Not compatible with ros 2 humble. Need to build form source
#
RUN apt remove -y ros-humble-ros-gz-bridge

#
# Build ros-humble-ros-gz-bridge from source & install GZ Garden
#
ENV ROS_DISTRO humble

# Update package list and install Gazebo Garden first
RUN apt-get update && apt-get install -y \
    gz-garden \
    gz-sim7-cli \
    libgz-transport12-dev \
    libgz-math7-dev \
    libgz-cmake3-dev \
    libignition-cmake2-dev \
    && apt-get -y autoremove \
    && apt-get clean autoclean \
    && rm -rf /var/lib/apt/lists/{apt,dpkg,cache,log} /tmp/* /var/tmp/*

# Create and navigate to workspace
RUN mkdir -p /home/user/ros2_ws/src/

# Clone the ros_gz repository
RUN cd /home/user/ros2_ws/src/ && git clone -b humble https://github.com/gazebosim/ros_gz.git

ENV GZ_VERSION=garden

# Initialize rosdep and install dependencies
RUN rosdep init && rosdep update

# Install dependencies and build
RUN cd /home/user/ros2_ws/ && \
    /bin/bash -c "source /opt/ros/humble/setup.bash && \
    rosdep install -r --from-paths src -i -y --ignore-src --rosdistro humble && \
    colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release"

# Source the workspace in bashrc
RUN echo "source /home/user/ros2_ws/install/setup.bash" >> /home/user/.bashrc

# Set correct workspace directory
WORKDIR /home/user/ros2_ws

#
# Install rqt_tf
#
RUN apt update && apt install -y ros-humble-rqt-tf-* \
	&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/*

#
# MAVROS dependencies
#
RUN apt update && \
    apt install -y \
        python3-vcstool \
        python3-rosinstall-generator \
        python3-osrf-pycommon \
        geographiclib-tools \
        libgeographic-dev \
		libasio-dev \
		libgoogle-glog-dev \
		ros-humble-eigen-stl-containers \
		ros-humble-diagnostic-updater \
		ros-humble-geographic-msgs \
		&& apt-get clean autoclean \
	&& rm -rf /var/lib/apt/lists/*

RUN geographiclib-get-geoids egm96-5 && \
    geographiclib-get-gravity egm96 && \
    geographiclib-get-magnetic emm2015
RUN pip3 install future

#
# Install ROSA (ROS Agent) - NASA JPL Task Planning Framework
#
RUN apt-get update && apt-get install -y \
		python3-colcon-common-extensions \
		python3-vcstool \
	&& rm -rf /var/lib/apt/lists/*

# Clone and build ROSA
RUN mkdir -p /home/user/rosa_ws/src && \
    cd /home/user/rosa_ws/src && \
    git clone https://github.com/nasa-jpl/rosa.git && \
    cd rosa && \
    git submodule update --init --recursive

# Install ROSA dependencies
RUN cd /home/user/rosa_ws && \
    /bin/bash -c "source /opt/ros/humble/setup.bash && \
    rosdep install --from-paths src --ignore-src -r -y"

# Build ROSA
RUN cd /home/user/rosa_ws && \
    /bin/bash -c "source /opt/ros/humble/setup.bash && \
    colcon build"

#
# Install Ollama for local LLM support
#
RUN curl -fsSL https://ollama.com/install.sh | sh

#
# Install ChatOllama (LangChain integration)
#
RUN pip3 install langchain langchain-community ollama

#
# Pull Qwen3:8b model using Ollama
#
RUN /bin/bash -c "ollama serve &" && \
    sleep 10 && \
    ollama pull qwen3:8b || echo "Failed to pull model during build, will try in container runtime"

# Change ownership of workspaces
RUN chown -R user:user /home/user/rosa_ws /home/user/ros2_ws

# Source ROS2 and ROSA in bashrc
RUN echo "source /home/user/rosa_ws/install/setup.bash" >> /home/user/.bashrc

# Create entrypoint script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Source ROS2\n\
source "/opt/ros/humble/setup.bash"\n\
\n\
# Source ROSA\n\
source "/home/user/rosa_ws/install/setup.bash"\n\
\n\
# Start Ollama service in background\n\
ollama serve &\n\
\n\
# Wait for Ollama to start\n\
sleep 5\n\
\n\
# Execute the command\n\
exec "$@"' > /entrypoint.sh && \
chmod +x /entrypoint.sh

# Copy middleware profiles
RUN mkdir -p /usr/local/share/middleware_profiles
COPY middleware_profiles/*profile.xml /usr/local/share/middleware_profiles/
ENV RMW_IMPLEMENTATION=rmw_fastrtps_cpp

# Expose Ollama default port
EXPOSE 11434

ENTRYPOINT ["/entrypoint.sh"]

WORKDIR /home/user
CMD ["/bin/bash"]